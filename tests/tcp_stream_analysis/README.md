# TCP流分析工具

这个工具用于分析TCP视频流的详细信息，包括帧率、分辨率、数据传输率等。

## 文件说明

- `test_tcp_stream_info.py` - 主要的TCP流分析工具
- `run_tcp_analysis.py` - 简单的运行脚本
- `tcp_analysis_results/` - 分析结果输出目录（自动创建）

## 使用方法

### 1. 直接运行分析工具

```bash
cd vlm_monitor/tests/tcp_stream_analysis
python test_tcp_stream_info.py
```

### 2. 使用运行脚本

```bash
cd vlm_monitor/tests/tcp_stream_analysis
python run_tcp_analysis.py
```

### 3. 从项目根目录运行

```bash
cd vlm_monitor
python -m tests.tcp_stream_analysis.test_tcp_stream_info
```

## 功能特性

### 分析内容

1. **连接测试** - 测试TCP连接是否正常
2. **帧大小检测** - 检测第一个数据包的帧大小
3. **视频流分析** - 分析视频帧的详细信息：
   - 帧率 (FPS)
   - 分辨率 (宽x高)
   - 帧大小 (MB)
   - 数据传输率 (MB/s)
   - 颜色通道数

### 输出报告

工具会生成两种格式的报告：

1. **JSON报告** - 包含完整的分析数据，便于程序处理
2. **文本报告** - 人类可读的格式，便于查看

报告保存在 `tcp_analysis_results/` 目录中。

## 配置

工具会自动从 `config.json` 读取TCP服务器配置：

```json
{
  "stream": {
    "tcp": {
      "host": "localhost",
      "port": 1234
    }
  }
}
```

如果无法读取配置文件，会使用默认值：`localhost:1234`

## 分析参数

- **最大帧数**: 默认分析50帧
- **超时时间**: 默认30秒
- **帧率检测**: 自动计算实际帧率

## 故障排除

### 常见错误

1. **连接被拒绝**
   - 确保TCP视频服务器正在运行
   - 检查端口号是否正确

2. **帧大小异常**
   - 可能是数据格式不匹配
   - 检查TCP服务器的数据编码格式

3. **超时错误**
   - 增加超时时间
   - 检查网络连接

### 调试建议

1. 首先运行原始socket连接测试
2. 检查第一个数据包的帧大小
3. 如果帧大小异常（>100MB），可能是协议不匹配

## 示例输出

```
🚀 TCP视频流分析工具
==================================================
📋 从配置文件读取TCP设置: localhost:1234

🔍 开始分析TCP流...

📡 阶段1: 原始socket连接分析
🔌 尝试连接到 localhost:1234...
✅ 原始socket连接成功
📦 尝试接收第一个数据包...
📏 接收到帧大小: 2764800 bytes (2.64 MB)
✅ 帧大小正常: 2764800 bytes

🎥 阶段2: TCP客户端高级分析
🎬 开始收集最多 50 帧...
📊 已接收 10 帧, 当前fps: 24.85, 分辨率: 1920x720
📊 已接收 20 帧, 当前fps: 24.92, 分辨率: 1920x720
...

✅ 分析完成:
  - 总帧数: 50
  - 主要分辨率: 1920x720
  - 平均帧率: 24.95 fps
  - 平均帧大小: 2.64 MB
  - 数据传输率: 65.88 MB/s
``` 